# File: 06_samtools_merge_array_job.R
# Auth: umar.niazi@kcl.as.uk
# DESC: create a parameter file and shell script to run array job on hpc
# Date: 21/10/2021


## set variables and source libraries
source('header.R')

csFiles = list.files('dataExternal/remote/Aligned/', '*rd.bam$')

# load meta data
dfMeta = read.csv('dataExternal/fileList.csv', header=T, stringsAsFactors = F)
str(dfMeta)
table(dfMeta$Group)
# merge the group LS
i = which(dfMeta$Group == 'LS')
dfMeta = dfMeta[i,]
# match the file names with sample names in meta table
f = gsub('_q30_.+', '', csFiles)
i = match(dfMeta$SampleID, f)
# sanity check
identical(dfMeta$SampleID, f[i])
dfMeta$files = csFiles[i]

## array job script
# set header variables 
cvShell = '#!/bin/bash -l'
cvJobName = '#SBATCH --job-name=samtools-array'
cvNodes = '#SBATCH --nodes=1'
cvProcessors = '#SBATCH --ntasks=1'
# format d-hh:mm:ss
cvRuntime = '#SBATCH --time=6-05:05:00'
cvPartition = '#SBATCH --partition brc'
# How much memory you need.
# --mem will define memory per node and
# --mem-per-cpu will define memory per CPU/core. Choose one of those.
cvMemoryReserve = '#SBATCH --mem-per-cpu=10000MB'
# Turn on mail notification. There are many possible self-explaining values:
# NONE, BEGIN, END, FAIL, ALL (including all aforementioned)
# For more values, check "man sbatch"
cvMail = '#SBATCH --mail-type=END,FAIL'
# set array job loop
cvArrayJob = '#SBATCH --array=1-1'

# set the directory names
cvInput = 'input/'
#cvSam = 'samtools'

# create a parameter file and shell script
dir.create('AutoScripts')
oFile.param = file('AutoScripts/samtools_merge_param.txt', 'wt')
csFiles = dfMeta$files


p1 = paste0(cvInput, csFiles)
p1 = paste(p1, collapse = ' ')
p1 = paste(paste0(cvInput, 'LS_merged.bam'), p1)
writeLines(p1, oFile.param)

close(oFile.param)

oFile = file('AutoScripts/samtools_merge.sh', 'wt')

writeLines(c(cvShell, cvJobName, cvArrayJob, cvNodes, cvProcessors, 
             cvRuntime, cvPartition, cvMemoryReserve, cvMail), oFile)

writeLines(c('# Autogenerated script from write_samtools_script.R', paste('# date', date())), oFile)
writeLines(c('# make sure directory paths exist before running script'), oFile)
writeLines('\n\n', oFile)

# module load
writeLines(c('module load apps/samtools/1.10.0-singularity'), oFile)
writeLines('\n\n', oFile)

## write array job lines
writeLines("# Parse parameter file to get variables.
           number=$SLURM_ARRAY_TASK_ID
           paramfile=samtools_merge_param.txt
           
           merged=`sed -n ${number}p $paramfile | awk '{print $1}'`
           bamfiles=`sed -n ${number}p $paramfile | cut -f 2- -d ' '`
           
           # 9. Run the program.", oFile)

# sam to bam
p1 = paste('samtools merge', '$merged', '$bamfiles', sep=' ')
com1 = paste(p1)
# create index 
p1 = paste('samtools index', '$merged', sep=' ')
com2 = paste(p1)

writeLines(c(com1, com2), oFile)
writeLines('\n\n', oFile)

close(oFile)

