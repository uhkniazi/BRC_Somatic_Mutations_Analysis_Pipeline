# File: 03_trimmomatic_array_job.R
# Auth: umar.niazi@kcl.as.uk
# DESC: create a parameter file and shell script to run array job on hpc
# Date: 22/9/2021


## set variables and source libraries
source('header.R')

setwd(gcRemoteDir)
csFiles = list.files('BRC_Somatic_Mutations_Analysis_Pipeline/dataExternal/pilotProjectDump/', 
                     pattern = '*.fastq')

#dfData = read.csv(file.choose(), header=T)
dfData = data.frame(Run=I(csFiles))
setwd(gcswd)
# set header variables 
cvShell = '#!/bin/bash -l'
cvJobName = '#SBATCH --job-name=trim-array'
cvNodes = '#SBATCH --nodes=1'
cvProcessors = '#SBATCH --ntasks=1'
# format d-hh:mm:ss
cvRuntime = '#SBATCH --time=0-05:005:00'
cvPartition = '#SBATCH --partition brc'
# How much memory you need.
# --mem will define memory per node and
# --mem-per-cpu will define memory per CPU/core. Choose one of those.
cvMemoryReserve = '#SBATCH --mem-per-cpu=10000MB'
# Turn on mail notification. There are many possible self-explaining values:
# NONE, BEGIN, END, FAIL, ALL (including all aforementioned)
# For more values, check "man sbatch"
cvMail = '#SBATCH --mail-type=END,FAIL'
# set array job loop
#length(cvQueries)
dim(dfData)
cvArrayJob = '#SBATCH --array=1-8'

# set the directory names for trimmomatic
cvInput = 'input/'
cvOutput = 'output/Trimmed/'
cvOutput.unpaired = paste0(cvOutput, 'Unpaired/')
cvTrimmomatic = 'trimmomatic'
cvIlluminaAdap = '/users/k1625253/scratch/old-scratch_rosalind-legacy-import_2020-01-28/Data/MetaData/trimmomatic_adapters.fa'

# create a parameter file and shell script
dir.create('AutoScripts')
oFile.param = file('AutoScripts/trimmomatic_param.txt', 'wt')

## check file names
#f = list.files('dataExternal/remote/raw/temp_SRP319967/', pattern = 'fastq')
dfData$Run
# get unique file name after removing forward / reverse marks
csFiles = unique(gsub('_\\d\\.fastq.gz', '', as.character(dfData$Run)))

temp = sapply(seq_along(csFiles), function(x){
  # get the file names
  #dfFiles = dbGetQuery(db, x)
  # check for null return
  # if (nrow(dfFiles) == 0) return();
  # # remove white space from title
  # dfFiles$title = gsub(" ", "", dfFiles$title, fixed=T)
  # # split the file names into paired end 1 and 2, identified by R1 and R2 in the file name
  # f = dfFiles$name
  # d = grepl('_R1_', f)
  # d = as.character(d)
  # d[d == 'TRUE'] = 'R1'
  # d[d == 'FALSE'] = 'R2'
  # f = as.character(dfData$Run[x])
  lf = list(paste0(csFiles[x], '_1.fastq.gz'),
            paste0(csFiles[x], '_2.fastq.gz'))
  
  # write trimmomatic command
  in.r1 = paste0(cvInput, lf[[1]])
  in.r2 = paste0(cvInput, lf[[2]])
  out.r1 = paste0(cvOutput, 'trim_', lf[[1]])
  out.r2 = paste0(cvOutput, 'trim_', lf[[2]])
  out.r1.up = paste0(cvOutput.unpaired, 'up_', lf[[1]])
  out.r2.up = paste0(cvOutput.unpaired, 'up_', lf[[2]])
  p1 = paste(in.r1, in.r2, out.r1, out.r1.up, out.r2, out.r2.up, sep=' ')
  writeLines(p1, oFile.param)
})

close(oFile.param)

oFile = file('AutoScripts/trimmomatic.sh', 'wt')

writeLines(c(cvShell, cvJobName, cvArrayJob, cvNodes, cvProcessors, 
             cvRuntime, cvPartition, cvMemoryReserve, cvMail), oFile)
writeLines(c('# Autogenerated script from write_trimmomatic_script.R', paste('# date', date())), oFile)
writeLines(c('# make sure directory paths exist before running script'), oFile)

writeLines('\n\n', oFile)

# module load
writeLines(c('module load apps/trimmomatic/0.39'), oFile)
writeLines('\n\n', oFile)

## write array job lines
writeLines("# Parse parameter file to get variables.
number=$SLURM_ARRAY_TASK_ID
paramfile=trimmomatic_param.txt
 
inr1=`sed -n ${number}p $paramfile | awk '{print $1}'`
inr2=`sed -n ${number}p $paramfile | awk '{print $2}'`
outr1=`sed -n ${number}p $paramfile | awk '{print $3}'`
outr1up=`sed -n ${number}p $paramfile | awk '{print $4}'`
outr2=`sed -n ${number}p $paramfile | awk '{print $5}'`
outr2up=`sed -n ${number}p $paramfile | awk '{print $6}'`

# 9. Run the program.", oFile)
p1 = paste(cvTrimmomatic, 'PE', '$inr1 $inr2 $outr1 $outr1up $outr2 $outr2up', sep=' ')
p2 = paste0('ILLUMINACLIP:', cvIlluminaAdap, ':2:30:10:8:true') # remove more stringent settings LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:36')
com = paste(p1, p2, sep=' ')

writeLines(com, oFile)
writeLines('\n\n', oFile)

close(oFile)
# dbDisconnect(db)